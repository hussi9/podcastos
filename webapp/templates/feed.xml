<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
    xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd"
    xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>{{ profile.name }}</title>
        <link>{{ base_url }}/profiles/{{ profile.id }}</link>
        <description>{{ profile.description or 'A podcast generated by Podcast Studio' }}</description>
        <language>{{ profile.language or 'en-US' }}</language>
        <lastBuildDate>{{ episodes[0].date.strftime('%a, %d %b %Y %H:%M:%S +0000') if episodes else '' }}</lastBuildDate>
        <generator>Podcast Studio v2</generator>

        <atom:link href="{{ base_url }}/profiles/{{ profile.id }}/feed.xml" rel="self" type="application/rss+xml"/>

        <!-- iTunes Metadata -->
        <itunes:author>{{ profile.name }}</itunes:author>
        <itunes:summary>{{ profile.description or 'A podcast generated by Podcast Studio' }}</itunes:summary>
        <itunes:type>episodic</itunes:type>
        <itunes:explicit>false</itunes:explicit>

        {% if profile.categories %}
        {% for category in profile.categories[:3] %}
        <itunes:category text="{{ category|title }}"/>
        {% endfor %}
        {% endif %}

        <itunes:image href="{{ base_url }}/static/podcast-cover.png"/>

        {% for episode in episodes %}
        <item>
            <title>{{ episode.title }}</title>
            <link>{{ base_url }}/episodes/{{ episode.id }}</link>
            <guid isPermaLink="false">{{ episode.episode_id }}</guid>
            <pubDate>{{ episode.date.strftime('%a, %d %b %Y %H:%M:%S +0000') if episode.date else '' }}</pubDate>
            <description>{{ episode.summary or 'No description available' }}</description>

            {% if episode.audio_path %}
            <enclosure
                url="{{ base_url }}/audio/{{ episode.audio_path.split('/')[-1] }}"
                type="audio/wav"
                length="{{ (episode.duration_seconds or 0) * 48000 }}"/>
            {% endif %}

            <!-- iTunes Episode Metadata -->
            <itunes:title>{{ episode.title }}</itunes:title>
            <itunes:summary>{{ episode.summary or 'No description available' }}</itunes:summary>
            {% if episode.duration_seconds %}
            <itunes:duration>{{ (episode.duration_seconds // 60) }}:{{ '%02d' % (episode.duration_seconds % 60) }}</itunes:duration>
            {% endif %}
            <itunes:explicit>false</itunes:explicit>
            <itunes:episodeType>full</itunes:episodeType>

            {% if episode.topics_covered %}
            <content:encoded><![CDATA[
                <h2>Topics Covered</h2>
                <ul>
                {% for topic in episode.topics_covered %}
                    <li>{{ topic }}</li>
                {% endfor %}
                </ul>

                {% if episode.key_facts %}
                <h2>Key Facts</h2>
                <ul>
                {% for fact in episode.key_facts %}
                    <li>{{ fact }}</li>
                {% endfor %}
                </ul>
                {% endif %}
            ]]></content:encoded>
            {% endif %}
        </item>
        {% endfor %}
    </channel>
</rss>
